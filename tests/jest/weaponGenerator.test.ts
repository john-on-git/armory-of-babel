import { getWeaponFeatureVersionController } from "$lib/generators/weaponGenerator/weaponFeatureVersionController";
import { mkWeapon, mkWeaponsForAllRarities } from "$lib/generators/weaponGenerator/weaponGeneratorLogic";
import type { FeatureProviderCollection } from "$lib/generators/weaponGenerator/weaponGeneratorTypes";

const nRuns = 1e2;


describe('Weapon Generator', () => {
    let weaponFeaturesByVersion: FeatureProviderCollection[];

    beforeAll(() => {
        const weaponFeatureVersionController = getWeaponFeatureVersionController();
        weaponFeaturesByVersion = new Array(weaponFeatureVersionController.getLatestVersionNum() + 1).fill(null).map((_, i) => weaponFeatureVersionController.getVersion(i));
    });

    it('1. Always generates a weapon with a number of active abilities matching its params.', () => {
        for (let i = 0; i < nRuns; i++) {
            const { weaponViewModel: weapon, params } = mkWeapon(i.toString(), weaponFeaturesByVersion[weaponFeaturesByVersion.length - 1], undefined, undefined, undefined, true);

            expect(weapon.active.powers.length).toBe(params.nActive + params.nUnlimitedActive);
        }
    });

    // Passives don't always create a bullepoint in the viewmodel, and sometimes increase the ability cap, 
    // but it shouldn't be wildly different. That might indicate a gracefully handled crash, or an infinite loop in the generation state space 
    it('2. Always generates a weapon with a number of passive abilities approximately equal to its params.', () => {
        for (let i = 0; i < nRuns; i++) {
            const { weaponViewModel: weapon, params } = mkWeapon(i.toString(), weaponFeaturesByVersion[weaponFeaturesByVersion.length - 1], undefined, undefined, undefined, true);

            // number of languages (excluding the standard option, common). languages are a kind of passive powers
            const nAdditionalLanguages = (weapon.sentient ? weapon.sentient.languages.length - 1 : 0);

            const absDifference = Math.abs(params.nPassive - (weapon.passivePowers.length + nAdditionalLanguages))
            expect(absDifference).toBeLessThanOrEqual(2);
        }
    });

    it('3. Always generates a weapon with a number of charges matching its params, or its most expensive ability, whichever is higher.', () => {
        for (let i = 0; i < nRuns; i++) {
            const { weaponViewModel: weapon, params } = mkWeapon(i.toString(), weaponFeaturesByVersion[weaponFeaturesByVersion.length - 1], undefined, undefined, undefined, true);

            const expected = weapon.active.powers.reduce<number>((acc, x) => Math.max(acc, typeof x.cost === 'string' ? 1 : x.cost), params.nCharges);

            expect(weapon.active.maxCharges).toBe(expected);
        }
    });

    it('4. Always generates a weapon with enough charges to use any of its actives at least once.', () => {
        for (let i = 0; i < nRuns; i++) {
            const { weaponViewModel: weapon } = mkWeapon(i.toString(), weaponFeaturesByVersion[weaponFeaturesByVersion.length - 1], undefined, undefined, undefined, true);

            weapon.active.powers.map(x => expect(typeof x.cost === 'string' ? 0 : x.cost).toBeLessThanOrEqual(weapon.active.maxCharges));
        }
    });

    it('5. Always generates a weapon that deals damage.', () => {
        for (let i = 0; i < nRuns; i++) {
            const { weaponViewModel: weapon } = mkWeapon(i.toString(), weaponFeaturesByVersion[weaponFeaturesByVersion.length - 1], undefined, undefined, undefined, true);

            expect((Object.values(weapon.damage) as (string | number)[]).some((x) => typeof (x) === 'string' || x > 0)).toBe(true);
        }
    });

    it('6. Always generates a weapon with a non-empty description.', () => {
        for (let i = 0; i < nRuns; i++) {
            const { weaponViewModel: weapon } = mkWeapon(i.toString(), weaponFeaturesByVersion[weaponFeaturesByVersion.length - 1], undefined, undefined, undefined, true);

            expect(weapon.description.length).toBeGreaterThan(0);
        }
    });


    it('7. Never generates a weapon with empty description bulletpoints.', () => {
        const notJustWhitespace = /\S+/;

        for (let i = 0; i < nRuns; i++) {
            const { weaponViewModel: weapon } = mkWeapon(i.toString(), weaponFeaturesByVersion[weaponFeaturesByVersion.length - 1], undefined, undefined, undefined, true);

            weapon.active.powers.forEach((active) => {
                expect(active.desc).toMatch(notJustWhitespace);
                if (active.additionalNotes !== undefined) {
                    active.additionalNotes.forEach(note => expect(note).toMatch(notJustWhitespace))
                }
            });
            weapon.passivePowers.forEach((passive) => expect(passive.desc.length).toBeGreaterThan(0));
        }
    });

    it('8. Never generates a weapon that contains text that is an indicator of broken functionality', () => {
        // i.e. "undefined", "[object ", "null"

        for (let i = 0; i < nRuns; i++) {
            const { weaponViewModel: weapon } = mkWeapon(i.toString(), weaponFeaturesByVersion[weaponFeaturesByVersion.length - 1], undefined, undefined, undefined, true);

            expect(/\s+null\s+|undefined|\[object Object\]/g.test(JSON.stringify(weapon))).toBe(false);
        }
    })

    it.skip('9. TODO Weapons never contain two components with the same UUID, unless that component is marked non-unique.', () => {
        // for (let i = 0; i < nRuns; i++) {
        //     const { weaponViewModel: weapon, params } = mkWeapon(i.toString(), weaponFeaturesByVersion[weaponFeaturesByVersion.length - 1]);

        // }
    });

    it.each([
        {
            id: '1', version: 0,
            expected: { "weapons": { "common": { "id": "1", "themes": ["dark"], "rarity": "common", "isNegative": false, "name": "Obsidian Greatsword", "pronouns": "object", "description": "Its blade is made of obsidian, and it leaves a wake of pure darkness behind it.", "damage": { "as": "greatsword", "const": 0, "d6": 1 }, "toHit": 0, "active": { "maxCharges": 0, "rechargeMethod": "a charge when used to defeat a foe", "powers": [] }, "passivePowers": [], "sentient": false }, "uncommon": { "id": "1", "themes": ["light"], "rarity": "uncommon", "isNegative": false, "name": "Golden Greathammer", "pronouns": "object", "description": "Its head is made of white gold, and the grip is made of crystal.", "damage": { "as": "greatclub", "const": 1 }, "toHit": 1, "active": { "maxCharges": 4, "rechargeMethod": "all charges at noon on the summer solstice", "powers": [{ "desc": "Protection from Curses", "cost": 1, "additionalNotes": ["You level the weapon at another character, and they're briefly surrounded by divine light.", "For the rest of the scene, they cannot be cursed."] }] }, "passivePowers": [{ "desc": "Whenever the wielder defeats a foe, they gain 1d6 temporary hit points." }], "sentient": false }, "rare": { "id": "1", "themes": ["fire"], "rarity": "rare", "isNegative": false, "name": "Golden Quarterstaff", "pronouns": "object", "description": "Its body is made of gold-plated steel, and it has patterns on its surface depicting red flames radiating outwards from the base.", "damage": { "as": "staff", "const": 2 }, "toHit": 2, "active": { "maxCharges": 9, "rechargeMethod": "all charges at noon on the summer solstice", "powers": [{ "desc": "Pile of Glass", "cost": "a charge per month that an expert would need to produce a regular version of the object", "additionalNotes": ["Molten glass bursts from the weapon, levitating into place to form a facsimile of an object of your choice.", "It's made entirely of glass. Initially intangible, it finishes solidifying at the start of your next turn.", "Only replicates the form of the object, not any special functions. Its magical nature is obvious at a glance."] }] }, "passivePowers": [{ "desc": "Can transform into a lighter." }], "sentient": false }, "epic": { "id": "1", "themes": ["fire"], "rarity": "epic", "isNegative": false, "name": "The Bo-Stick of the Bonfire Keeper", "pronouns": "object", "description": "Its body is made of gold, and it has patterns on its surface depicting purple flames radiating outwards from the base.", "damage": { "as": "staff", "const": 4 }, "toHit": 4, "active": { "maxCharges": 11, "rechargeMethod": "a charge when used to defeat a foe", "powers": [{ "desc": "Summon Fire Elemental", "cost": 6, "additionalNotes": ["Dissipates after 1 hour."] }] }, "passivePowers": [{ "desc": "Can transform into a 10-ft pole, or shrink to the size of a toothpick." }, { "desc": "The wielder gains a +5 bonus to feats of strength or agility that involve the weapon." }], "sentient": false }, "legendary": { "id": "1", "themes": ["ice"], "rarity": "legendary", "isNegative": false, "name": "Bavin, the Icebound Bladed Bow", "pronouns": "masc", "description": "His blades each have a large crystal orb embedded in them, containing a welter of winter weather, and his quiver has a pair of blue eyes indented slightly into the surface.", "damage": { "as": "sword (or bow)", "const": 4 }, "toHit": 4, "active": { "maxCharges": 11, "rechargeMethod": "one charge at the end of each scene where his wielder made an ice pun", "powers": [{ "desc": "Icebound", "cost": 1, "additionalNotes": ["Lock a mechanism in place with magical ice as strong as steel.", "It stays frozen for 2d6 × 10 minutes."] }, { "desc": "Slow Bomb", "cost": 3, "additionalNotes": ["A sphere of ice forms at the weapon's tip, hovering around eye level. At the start of each of your turns, it moves 10-ft closer to the nearest foe.", "If touched, it explodes with a 30-ft radius. Targets save, taking 10d12 damage on a fail and half as much on a success."] }, { "desc": "Ice Sheet", "cost": 2, "additionalNotes": ["A wave of frost emanates from the weapon. Surfaces and bodies of liquid within a 120-ft radius freeze into a sheet of ice. The wielder decides how thick the ice is (max 1-ft)."] }, { "desc": "Frigid Plate", "cost": 1, "additionalNotes": ["You level the weapon at another character, and the atmosphere freezes around them as armor.", "It has stats as plate (+2). At the end of the scene, it shatters and falls off."] }, { "desc": "Disarm", "cost": "at will", "additionalNotes": ["The weapon magically guides your hand to disarm an opponent.", "They are forced to drop an object they're holding, no save."] }] }, "passivePowers": [{ "desc": "Can transform into a set of ice picks." }, { "desc": "When the weapon's blade is coated in the blood of a character with an elemental weakness, it glows the color of the element they're weak to, as bright as a torch." }, { "desc": "Anything killed by the weapon explodes in a blast of icy wind. The blast deals 2d6 damage, with a range of 10-ft. It does not harm the wielder." }], "sentient": { "personality": ["Merciless.", "Jealous."], "languages": ["Common.", "White-Draconic.", "Frost Giant."], "chanceOfMakingDemands": 6 } } }, "n": 0.2694488477791326 }
        },
        {
            id: '2', version: 0,
            expected: { "weapons": { "common": { "id": "2", "themes": ["sour"], "rarity": "common", "isNegative": false, "name": "Toxic Glaive", "pronouns": "object", "description": "Its head is made of citrine, and it is pitted and scratched.", "damage": { "as": "polearm", "const": 0 }, "toHit": 0, "active": { "maxCharges": 0, "rechargeMethod": "one charge each time its wielder insults someone", "powers": [] }, "passivePowers": [{ "desc": "Licking the weapon cures scurvy. It tastes sour." }], "sentient": false }, "uncommon": { "id": "2", "themes": ["wizard"], "rarity": "uncommon", "isNegative": false, "name": "Ultraviolet Lance", "pronouns": "object", "description": "Its pommel has a piece of porphyry embedded in it.", "damage": { "as": "lance", "const": 2 }, "toHit": 2, "active": { "maxCharges": 4, "rechargeMethod": "all charges when its wielder learns a new spell", "powers": [] }, "passivePowers": [{ "desc": "Deals 1d8 additional damage vs fae." }], "sentient": false }, "rare": { "id": "2", "themes": ["sour", "light"], "rarity": "rare", "isNegative": false, "name": "Corrosive Shotel", "pronouns": "object", "description": "Its blade is made of acidium, and it has  a vein of radium running down the center. The crossguard has an acid diamond embedded in it, and the pommel has  a tendril extending from it, which usually wraps around the grip.", "damage": { "as": "sword", "const": 4 }, "toHit": 4, "active": { "maxCharges": 5, "rechargeMethod": "a charge when used to defeat a foe", "powers": [{ "desc": "Atomic Blast", "cost": 2, "additionalNotes": ["You strike at the air, launching a wave of atomic energy.", "It deals 2d6 + 8 damage, range as sling."] }, { "desc": "Deny Disarm", "cost": 1, "additionalNotes": ["In response to an attempt to disarm you, the tendril on the weapon grips around your forearm, foiling the attempt."] }] }, "passivePowers": [{ "desc": "While the weapon is drawn the wielder cannot feel fear, and their morale cannot break." }], "sentient": false }, "epic": { "id": "2", "themes": ["nature", "sour"], "rarity": "epic", "isNegative": false, "name": "Emerald Khopesh", "pronouns": "object", "description": "Its blade is made of bronze, and it has luminous vines emerging from a crack in its centre, spreading outwards to wrap around it.", "damage": { "as": "sword", "const": 4 }, "toHit": 4, "active": { "maxCharges": 7, "rechargeMethod": "a charge when used to defeat a foe", "powers": [{ "desc": "Empowered Attack", "cost": 2, "additionalNotes": ["You empower an attack to deal an additional 2d10 damage, as the weapon projects a spectral cobra that attacks the target."] }, { "desc": "Disarm", "cost": 2, "additionalNotes": ["The weapon magically guides your hand to disarm an opponent.", "They are forced to drop an object they're holding, no save."] }, { "desc": "Kinesis", "cost": 1, "additionalNotes": ["A sturdy vine grows from the weapon's tip. It can lift and throw an object within 60-ft, weighing up to 500 lbs."] }] }, "passivePowers": [{ "desc": "+4 to hit and damage vs foes more powerful than the wielder." }, { "desc": "While the weapon is drawn the wielder cannot feel fear, and their morale cannot break." }], "sentient": false }, "legendary": { "id": "2", "themes": ["sour", "light"], "rarity": "legendary", "isNegative": false, "name": "Maca, the Sunlit Axe", "pronouns": "femm", "description": "Her head is made of pure light, it is polished to a mirror finish, it has a number of dark and discolored sections, and it has four beady grey eyes mounted in two sets. Her grip is made of wood from a heavenly peach tree.", "damage": { "as": "axe", "const": 5 }, "toHit": 5, "active": { "maxCharges": 11, "rechargeMethod": "one charge each time her wielder insults someone", "powers": [{ "desc": "Banishment", "cost": 4, "additionalNotes": ["You empower an attack to banish a foe.", "The target must save or be magically transported back to their home."] }, { "desc": "Bless", "cost": 1, "additionalNotes": ["You level the weapon at another character, and they're briefly surrounded by divine light.", "For the rest of the scene, they gain 1d4 temporary hit points at the start of each of their turns."] }, { "desc": "Return", "cost": "at will", "additionalNotes": ["The weapon is bound to a particular location, you can slice the air to open a portal to it. It stays open for 1 minute before collapsing.", "The location is fixed and decided by the referee. Typical locations include the place the weapon was forged, or the fortress of a previous wielder."] }] }, "passivePowers": [{ "desc": "Extremely shiny, functions as a mirror." }, { "desc": "Licking the weapon cures scurvy. It tastes sour." }, { "desc": "Glows like a torch when ghost are near." }], "sentient": { "personality": ["Honest.", "Pacifist."], "languages": ["Common.", "Angelic.", "The liturgical language of their religion.", "Metal-Draconic."], "chanceOfMakingDemands": 8 } } }, "n": 0.7153687886990808 }
        },
        {
            id: '3', version: 0,
            expected: { "weapons": { "common": { "id": "3", "themes": ["dark"], "rarity": "common", "isNegative": false, "name": "Raven Staff", "pronouns": "object", "description": "Its body has 2 magical gems embedded along it, and it is engraved with a raven.", "damage": { "as": "staff", "const": 0 }, "toHit": 0, "active": { "maxCharges": 0, "rechargeMethod": "one charge when its wielder defenestrates a priest, or all charges if it was a high ranking priest", "powers": [] }, "passivePowers": [{ "desc": "Counter.", "additionalNotes": ["Upon a miss, the weapon gains 1 Counter.", "Upon a hit, the wielder may expend all Counter to deal 1d6 additional damage per point expended.", "It can store up to 2 Counter, and its gems light up to indicate the current amount."] }], "sentient": false }, "uncommon": { "id": "3", "themes": ["light"], "rarity": "uncommon", "isNegative": false, "name": "Silvery Trident", "pronouns": "object", "description": "Its prongs are made of silver-plated steel.", "damage": { "as": "spear", "const": 0 }, "toHit": 0, "active": { "maxCharges": 6, "rechargeMethod": "all charges after an hour in a sacred space", "powers": [] }, "passivePowers": [{ "desc": "Touching the weapon's tip dispels magical disguises, and causes shapeshifters to return to their normal form." }], "sentient": false }, "rare": { "id": "3", "themes": ["dark", "steampunk"], "rarity": "rare", "isNegative": false, "name": "Morota, the Party Halberd", "pronouns": "femm", "description": "Her head is made of copper, it inscribed with the word \"Drugs\", and it has four gold eyes mounted in two sets, indented slightly into the surface.", "damage": { "as": "polearm", "const": 3 }, "toHit": 3, "active": { "maxCharges": 6, "rechargeMethod": "all charges when her wielder invents something", "powers": [{ "desc": "Distant Strike", "cost": 1, "additionalNotes": ["For one attack, the weapon is surrounded by a larger shadow of itself, increasing its range by 10-ft."] }, { "desc": "Spectral Strike", "cost": 2, "additionalNotes": ["You empower an attack to bypass defenses. During the attack the weapon can phase through terrain, and ignores the effects of armor."] }] }, "passivePowers": [{ "desc": "Can transform into a skateboard." }, { "desc": "Whenever the wielder defeats a foe, the weapon gains 2d8 damage until the end of their turn (stacks)." }], "sentient": { "personality": ["Logical.", "Skeptic."], "languages": ["Common.", "Goblonic."], "chanceOfMakingDemands": 8 } }, "epic": { "id": "3", "themes": ["dark", "sweet"], "rarity": "epic", "isNegative": false, "name": "Moromerion, the Candied Trident", "pronouns": "masc", "description": "His prongs are made of rock candy, they leave a wake of pure darkness behind them, they inscribed with the word \"Drugs\", and they each have a cluster of beady red eyes mounted on them.", "damage": { "as": "spear", "const": 2, "d6": 1 }, "toHit": 2, "active": { "maxCharges": 8, "rechargeMethod": "one charge when his wielder defenestrates a priest, or all charges if it was a high ranking priest", "powers": [{ "desc": "Sweetberry", "cost": 3, "additionalNotes": ["Create a small berry, stats as healing potion."] }, { "desc": "Distant Strike", "cost": 1, "additionalNotes": ["For one attack, the weapon is surrounded by a larger shadow of itself, increasing its range by 20-ft."] }, { "desc": "Spectral Strike", "cost": 2, "additionalNotes": ["You empower an attack to bypass defenses. During the attack the weapon can phase through terrain, and ignores the effects of armor."] }] }, "passivePowers": [{ "desc": "Wholesome aura. The wielder has a +1 bonus to reaction rolls." }, { "desc": "Whenever the wielder defeats a foe, they may immediately make another attack." }], "sentient": { "personality": ["Sadistic.", "Merciless."], "languages": ["Common.", "Necromantic."], "chanceOfMakingDemands": 6 } }, "legendary": { "id": "3", "themes": ["dark", "sweet"], "rarity": "legendary", "isNegative": false, "name": "Logan, the Meteoric Iron Halberd", "pronouns": "masc", "description": "His head is made of meteoric iron, it is engraved with a demon, and it has jet black eyes dotted randomly across it, indented slightly into the surface.", "damage": { "as": "polearm", "const": 3 }, "toHit": 3, "active": { "maxCharges": 18, "rechargeMethod": "one charge upon absorbing a human soul", "powers": [{ "desc": "Sugar Spray", "cost": 1, "additionalNotes": ["Sprays a sweet and sticky syrup, enough to coat the floor of a small room. Makes movement difficult."] }, { "desc": "Focus Strike", "cost": 1, "additionalNotes": ["You mentally sync with the weapon, granting +1d12 to hit this attack."] }, { "desc": "Turn Priests & Angels", "cost": 2 }, { "desc": "Distant Strike", "cost": "at will", "additionalNotes": ["For one attack, the weapon is surrounded by a larger shadow of itself, increasing its range by 20-ft."] }] }, "passivePowers": [{ "desc": "Deals 3d8 additional damage vs extraplanar creatures." }, { "desc": "Whenever the wielder defeats a foe, they may immediately leap up to 10-ft (without triggering opportunity attacks)." }, { "desc": "The weapon can telepathically control bees within 100-ft. They can only understand simple commands." }], "sentient": { "personality": ["Sadistic.", "Merciless."], "languages": ["Common.", "Necromantic.", "Undercommon.", "Demonic."], "chanceOfMakingDemands": 4 } } }, "n": 0.8486474710186808 },
        },
        {
            id: '4', version: 0,
            expected: { "weapons": { "common": { "id": "4", "themes": ["nature"], "rarity": "common", "isNegative": false, "name": "The Naginata of the Forest", "pronouns": "object", "description": "Its head is made of bronze.", "damage": { "as": "polearm", "const": 1 }, "toHit": 1, "active": { "maxCharges": 0, "rechargeMethod": "a charge when used to defeat a foe", "powers": [] }, "passivePowers": [{ "desc": "Wielder is immune to poison." }], "sentient": false }, "uncommon": { "id": "4", "themes": ["ice"], "rarity": "uncommon", "isNegative": false, "name": "Golden Kukri", "pronouns": "object", "description": "Its blade is made of white gold.", "damage": { "as": "dagger", "const": 2 }, "toHit": 2, "active": { "maxCharges": 5, "rechargeMethod": "one charge whenever its wielder builds a snowman", "powers": [] }, "passivePowers": [{ "desc": "When the weapon's blade is coated in the blood of a character with an elemental weakness, it glows the color of the element they're weak to, as bright as a torch." }], "sentient": false }, "rare": { "id": "4", "themes": ["dark"], "rarity": "rare", "isNegative": false, "name": "Cenobite's Morning-Star", "pronouns": "object", "description": "Its head is engraved with a scary face.", "damage": { "as": "mace", "const": 4 }, "toHit": 4, "active": { "maxCharges": 5, "rechargeMethod": "one charge when its wielder defenestrates a priest, or all charges if it was a high ranking priest", "powers": [{ "desc": "Focus Strike", "cost": 1, "additionalNotes": ["The weapon magically sharpens your focus, granting +1d8 to hit this attack."] }] }, "passivePowers": [{ "desc": "Whenever the wielder defeats a foe, the weapon gains 2d8 damage until the end of their turn (stacks)." }, { "desc": "The wielder can summon the weapon into their hand at will, so long as it's on the same plane." }], "sentient": false }, "epic": { "id": "4", "themes": ["earth"], "rarity": "epic", "isNegative": false, "name": "Sanguine Shotel", "pronouns": "object", "description": "Its blade is made of telekill alloy, and the crossguard has a ruby embedded in it.", "damage": { "as": "sword", "const": 4 }, "toHit": 4, "active": { "maxCharges": 7, "rechargeMethod": "all charges when its wielder meditates atop a mountain", "powers": [{ "desc": "Stoneskin", "cost": 2, "additionalNotes": ["In response to being attacked, you briefly turn to stone.", "The attacker suffers -5 to hit."] }] }, "passivePowers": [{ "desc": "When the wielder saves against psionic effects, the effects of all relevant skills and bonuses are doubled." }, { "desc": "Wielder cannot be petrified." }, { "desc": "All sound is erased within 10-ft of the weapon. The aura is inactive while the weapon is sheathed." }], "sentient": false }, "legendary": { "id": "4", "themes": ["dark"], "rarity": "legendary", "isNegative": false, "name": "Logan, the Chaotic Triple Flail", "pronouns": "masc", "description": "His heads have 5 magical gems embedded along them, they are shaped like corkscrews, each has a bolt of dark energy crackling eternally at its center, and they each have black & red eyes dotted randomly across them, indented slightly into the surface.", "damage": { "as": "mace", "const": 5 }, "toHit": 5, "active": { "maxCharges": 16, "rechargeMethod": "one charge when his wielder defenestrates a priest, or all charges if it was a high ranking priest", "powers": [{ "desc": "Tenth Circle", "cost": 3, "additionalNotes": ["The target is snapped up whole by a titanic thing from the space-between-spaces", "It emerges from an edge, targeting something within 15-ft.", "Targets save at the end of each of their turns, ending the effect on a success. The chance is 20% for a character with no modifiers."] }, { "desc": "Dark Reflection", "cost": 2, "additionalNotes": ["The weapon emits two illusory duplicates of you, which appear to fight by your side.", "When you are hit, there's a 1-in-2 chance that it targets a duplicate instead, destroying it and leaving you unharmed."] }, { "desc": "Life Drain", "cost": 3, "additionalNotes": ["Upon landing a blow, you empower it to drain the target's life force. You regain HP equal to the damage dealt.", "HP gained in this way can heal you over your natural cap, but any HP over the cap is lost at the end of the scene."] }, { "desc": "Dark Blast", "cost": "at will", "additionalNotes": ["You strike at the air, launching a wave of dark energy.", "It deals 2d6 + 10 damage, range as sling."] }] }, "passivePowers": [{ "desc": "Magical effects will not function within 10-ft of the weapon, except those generated by it. The aura is inactive while the weapon is sheathed." }, { "desc": "Counter.", "additionalNotes": ["Upon a miss, the weapon gains 1 Counter.", "Upon a hit, the wielder may expend all Counter to deal 1d6 additional damage per point expended.", "It can store up to 5 Counter, and its gems light up to indicate the current amount."] }, { "desc": "The wielder can banish the weapon to a pocket plane, then withdraw it at will." }], "sentient": { "personality": ["Jealous.", "Depressive."], "languages": ["Common.", "Necromantic."], "chanceOfMakingDemands": 8 } } }, "n": 0.35820882139702814 },
        },
        {
            id: '5', version: 0,
            expected: { "weapons": { "common": { "id": "5", "themes": ["fire"], "rarity": "common", "isNegative": false, "name": "Rainbow Nodachi", "pronouns": "object", "description": "Its blade shines like a rainbow when viewed from the right angle.", "damage": { "as": "greatsword", "const": 0 }, "toHit": 0, "active": { "maxCharges": 0, "rechargeMethod": "all charges at noon on the summer solstice", "powers": [] }, "passivePowers": [{ "desc": "Can transform into a lighter." }], "sentient": false }, "uncommon": { "id": "5", "themes": ["cloud"], "rarity": "uncommon", "isNegative": false, "name": "Pevina, the Cloudborn Flail", "pronouns": "femm", "description": "Her head has a sheen that changes between red and yellow depending on the viewing angle, and her grip is made of wood from a sky-land tree. Her chain has three cyan eyes mounted in a triangle, indented slightly into the surface.", "damage": { "as": "mace", "const": 2 }, "toHit": 2, "active": { "maxCharges": 5, "rechargeMethod": "one charge each time you defeat a winged creature, or all charges if it was also a powerful foe", "powers": [{ "desc": "Spectral Strike", "cost": 2, "additionalNotes": ["You empower an attack to bypass defenses. During the attack the weapon can phase through terrain, and ignores the effects of armor."] }] }, "passivePowers": [{ "desc": "When this weapon's damage roll is the maximum possible, the target is stunned (if your system has no stun mechanic, they skip their next turn)." }], "sentient": { "personality": ["Curious.", "Acquiescent."], "languages": ["Common.", "Valkyrian.", "Sky Giant."], "chanceOfMakingDemands": 8 } }, "rare": { "id": "5", "themes": ["sour"], "rarity": "rare", "isNegative": false, "name": "Lemony Rapier", "pronouns": "object", "description": "Its blade is pitted and scratched, and the grip is made of lemon tree wood.", "damage": { "as": "sword", "const": 4 }, "toHit": 4, "active": { "maxCharges": 8, "rechargeMethod": "all charges after an hour immersed in acid", "powers": [{ "desc": "Acid Edge", "cost": 5, "additionalNotes": ["The weapon glows with caustic energy, lasting for 1 minute.", "It can cut through any organic material, metal, and stone (but not glass)."] }, { "desc": "Dash", "cost": 1, "additionalNotes": ["Move up to 2× your normal movement to attack someone.", "If you hit, they must save or be knocked down."] }] }, "passivePowers": [{ "desc": "Poisons (and potions) that are delivered using the weapon have their effects doubled." }, { "desc": "Whenever the wielder defeats a foe, the weapon gains 2d6 damage until the end of their turn (stacks)." }], "sentient": false }, "epic": { "id": "5", "themes": ["sour"], "rarity": "epic", "isNegative": false, "name": "Pevina, the Headhunter Foil", "pronouns": "femm", "description": "Her grip has a small glass vial built into it, and her crossguard has three green eyes mounted in a triangle, indented slightly into the surface. Her pommel has  a tendril extending from it, which usually wraps around the grip.", "damage": { "as": "sword", "const": 4 }, "toHit": 4, "active": { "maxCharges": 10, "rechargeMethod": "one charge each time her wielder insults someone", "powers": [{ "desc": "Deny Disarm", "cost": 1, "additionalNotes": ["In response to an attempt to disarm you, the tendril on the weapon grips around your forearm, foiling the attempt."] }, { "desc": "Caustic Chain", "cost": 3, "additionalNotes": ["Infuse a strike with lingering acid, dealing d6 damage to the target at the start of each of their turns.", "Each time it deals damage, the effect has a 1-in-10 chance of wearing off."] }] }, "passivePowers": [{ "desc": "While the weapon is drawn the wielder cannot feel fear, and their morale cannot break." }, { "desc": "Has a small vial built into it, which can be filled with fluid. When you land a blow with the weapon, you may expend the liquid, injecting it into the target." }, { "desc": "All sound is erased within 10-ft of the weapon. The aura is inactive while the weapon is sheathed." }], "sentient": { "personality": ["Sassy.", "Jealous."], "languages": ["Common.", "Black-Draconic."], "chanceOfMakingDemands": 6 } }, "legendary": { "id": "5", "themes": ["sour"], "rarity": "legendary", "isNegative": false, "name": "Lacricina, the Atomic Machete", "pronouns": "femm", "description": "Her blade has  a vein of radium running down the center, and her crossguard has three beady lime eyes mounted in a triangle. Her pommel has  a tendril extending from it, which usually wraps around the grip.", "damage": { "as": "sword", "const": 5 }, "toHit": 5, "active": { "maxCharges": 16, "rechargeMethod": "one charge each time her wielder insults someone", "powers": [{ "desc": "Deny Disarm", "cost": 1, "additionalNotes": ["In response to an attempt to disarm you, the tendril on the weapon grips around your forearm, foiling the attempt."] }, { "desc": "Caustic Chain", "cost": 3, "additionalNotes": ["Infuse a strike with lingering acid, dealing d6 damage to the target at the start of each of their turns.", "Each time it deals damage, the effect has a 1-in-10 chance of wearing off."] }, { "desc": "Slow Bomb", "cost": 3, "additionalNotes": ["A sphere of toxic waste forms at the weapon's tip, hovering around eye level. At the start of each of your turns, it moves 10-ft closer to the nearest foe.", "If touched, it explodes with a 30-ft radius. Targets save, taking 10d10 damage on a fail and half as much on a success."] }, { "desc": "Dash", "cost": 1, "additionalNotes": ["Move up to 2× your normal movement to attack someone.", "If you hit, they must save or be knocked down."] }, { "desc": "Compelled Duel", "cost": "at will", "additionalNotes": ["You challenge another (armed) character to a duel, and the weapon's magic compels them to agree.", "Until one of you is defeated, neither of you can attack any other characters.", "If both duellists' weapons use charges, the winner's weapon absorbs all charges of the loser's weapon."] }] }, "passivePowers": [{ "desc": "Magical effects will not function within 10-ft of the weapon, except those generated by it. The aura is inactive while the weapon is sheathed." }, { "desc": "While the weapon is drawn the wielder cannot feel fear, and their morale cannot break." }, { "desc": "The wielder can banish the weapon to a pocket plane, then withdraw it at will." }], "sentient": { "personality": ["Sassy.", "Jealous."], "languages": ["Common.", "Black-Draconic."], "chanceOfMakingDemands": 4 } } }, "n": 0.07790030500910648 },
        },
        {
            id: '8', version: 0,
            expected: { "weapons": { "common": { "id": "8", "themes": ["steampunk"], "rarity": "common", "isNegative": false, "name": "Clockwork Greathammer", "pronouns": "object", "description": "Its head is made of copper, and the grip is made of tin.", "damage": { "as": "greatclub", "const": 0 }, "toHit": 0, "active": { "maxCharges": 0, "rechargeMethod": "all charges when its wielder invents something", "powers": [] }, "passivePowers": [{ "desc": "Whenever the wielder defeats a foe, they gain 1d4 temporary hit points." }], "sentient": false }, "uncommon": { "id": "8", "themes": ["sour"], "rarity": "uncommon", "isNegative": false, "name": "Corrosive Foil", "pronouns": "object", "description": "Its blade is made of acidium.", "damage": { "as": "sword", "const": 0 }, "toHit": 0, "active": { "maxCharges": 5, "rechargeMethod": "all charges after an hour immersed in acid", "powers": [{ "desc": "Disarm", "cost": 2, "additionalNotes": ["The weapon magically guides your hand to disarm an opponent.", "They are forced to drop an object they're holding, no save."] }] }, "passivePowers": [{ "desc": "Wielder takes half damage from corrosive chemicals." }], "sentient": false }, "rare": { "id": "8", "themes": ["cloud", "wizard"], "rarity": "rare", "isNegative": false, "name": "Harron, the Ultraviolet Ultra-Greatsword", "pronouns": "masc", "description": "His blade is made of blue gold, and his grip is made of purple dragon horn. His crossguard has a piece of porphyry embedded in it, an amethyst bracelet wrapped around it, and a pair of beady blue eyes.", "damage": { "as": "greatsword", "const": 3, "d6": 1 }, "toHit": 3, "active": { "maxCharges": 10, "rechargeMethod": "one charge each time you defeat a winged creature, or all charges if it was also a powerful foe", "powers": [{ "desc": "Return", "cost": 3, "additionalNotes": ["The weapon is bound to a particular location, you can slice the air to open a portal to it. It stays open for 1 minute before collapsing.", "The location is fixed and decided by the referee. Typical locations include the place the weapon was forged, or the fortress of a previous wielder."] }, { "desc": "Wind Blast", "cost": 2, "additionalNotes": ["Characters in melee range must save, or take 1d6 damage, be thrown back out of melee range, and knocked down."] }] }, "passivePowers": [{ "desc": "There's a button on the side of the weapon. Pressing it causes the tip to emit a harmless beam of light." }], "sentient": { "personality": ["Logical.", "Know-it-All."], "languages": ["Common.", "Blue-Draconic"], "chanceOfMakingDemands": 10 } }, "epic": { "id": "8", "themes": ["light", "sour"], "rarity": "epic", "isNegative": false, "name": "The Longsword of the Lemon Lord", "pronouns": "object", "description": "Its grip is made of lemon tree wood, and the pommel has a diamond embedded in it.", "damage": { "as": "sword", "const": 2 }, "toHit": 2, "active": { "maxCharges": 12, "rechargeMethod": "all charges after an hour in a sacred space", "powers": [{ "desc": "Return", "cost": 3, "additionalNotes": ["The weapon is bound to a particular location, you can slice the air to open a portal to it. It stays open for 1 minute before collapsing.", "The location is fixed and decided by the referee. Typical locations include the place the weapon was forged, or the fortress of a previous wielder."] }, { "desc": "Cause Nausea", "cost": 1, "additionalNotes": ["You wave the weapon at a character. They must save or waste their turn vomiting."] }] }, "passivePowers": [{ "desc": "Wholesome aura. The wielder has a +1 bonus to reaction rolls." }, { "desc": "The wielder can summon the weapon into their hand at will, so long as it's on the same plane." }], "sentient": false }, "legendary": { "id": "8", "themes": ["sour"], "rarity": "legendary", "isNegative": false, "name": "Karen, the Acid Rapier", "pronouns": "femm", "description": "Her blade has 6 magical gems embedded along it, and her crossguard has a pair of beady lime eyes. Her pommel has  a tendril extending from it, which usually wraps around the grip.", "damage": { "as": "sword", "const": 3 }, "toHit": 3, "active": { "maxCharges": 14, "rechargeMethod": "a charge when used to defeat a foe", "powers": [{ "desc": "Deny Disarm", "cost": 1, "additionalNotes": ["In response to an attempt to disarm you, the tendril on the weapon grips around your forearm, foiling the attempt."] }, { "desc": "Disarm", "cost": 2, "additionalNotes": ["The weapon magically guides your hand to disarm an opponent.", "They are forced to drop an object they're holding, no save."] }, { "desc": "Caustic Chain", "cost": 3, "additionalNotes": ["Infuse a strike with lingering acid, dealing d6 damage to the target at the start of each of their turns.", "Each time it deals damage, the effect has a 1-in-10 chance of wearing off."] }, { "desc": "Return", "cost": 3, "additionalNotes": ["The weapon is bound to a particular location, you can slice the air to open a portal to it. It stays open for 1 minute before collapsing.", "The location is fixed and decided by the referee. Typical locations include the place the weapon was forged, or the fortress of a previous wielder."] }, { "desc": "Cause Nausea", "cost": "at will", "additionalNotes": ["You wave the weapon at a character. They must save or waste their turn vomiting."] }] }, "passivePowers": [{ "desc": "Licking the weapon cures scurvy. It tastes sour." }, { "desc": "Streak.", "additionalNotes": ["Upon a hit, the weapon gains +1 to hit.", "It can store up to +6, and its gems light up to indicate the current streak.", "Upon a miss, the weapon's streak is reset to 0."] }, { "desc": "While the weapon is drawn the wielder cannot feel fear, and their morale cannot break." }], "sentient": { "personality": ["Manic.", "Sassy."], "languages": ["Common.", "Black-Draconic."], "chanceOfMakingDemands": 4 } } }, "n": 0.620846741159765 },
        },
        {
            id: '9', version: 0,
            expected: { "weapons": { "common": { "id": "9", "themes": ["steampunk"], "rarity": "common", "isNegative": false, "name": "Porcelain Foil", "pronouns": "object", "description": "Its blade is made of brass, and the grip is made of porcelain.", "damage": { "as": "sword", "const": 0 }, "toHit": 0, "active": { "maxCharges": 0, "rechargeMethod": "all charges when its wielder invents something", "powers": [] }, "passivePowers": [{ "desc": "+5 to hit and damage vs foes more powerful than the wielder." }], "sentient": false }, "uncommon": { "id": "9", "themes": ["light"], "rarity": "uncommon", "isNegative": false, "name": "Golden Spear", "pronouns": "object", "description": "Its tip is made of white gold.", "damage": { "as": "spear", "const": 1 }, "toHit": 1, "active": { "maxCharges": 4, "rechargeMethod": "one charge each time you defeat an orc", "powers": [{ "desc": "Fantasy Form", "cost": "a charge per month that an expert would need to produce a regular version of the object", "additionalNotes": ["Light emanates from the weapon, forming a facsimile of an object of your choice.", "It's made of hard-light. Initially intangible, it finishes solidifying at the start of your next turn.", "Only replicates the form of the object, not any special functions. Its magical nature is obvious at a glance."] }] }, "passivePowers": [{ "desc": "Wielder is immune to the harmful effects of rays & beams." }], "sentient": false }, "rare": { "id": "9", "themes": ["steampunk", "wizard"], "rarity": "rare", "isNegative": false, "name": "Sapphire Halberd", "pronouns": "object", "description": "Its head is made of sapphire, and it is engraved with luminous depictions of the constellations.", "damage": { "as": "polearm", "const": 3 }, "toHit": 3, "active": { "maxCharges": 9, "rechargeMethod": "a charge when used to defeat a foe", "powers": [{ "desc": "Magic Missile", "cost": 2 }, { "desc": "Ward Other", "cost": 1, "additionalNotes": ["You wave the weapon at another character, as it summons sigils of arcane warding around them.", "For the rest of the scene, spells targeted at them have a 1-in-4 chance to deflect back at the caster."] }] }, "passivePowers": [{ "desc": "Can transform into a quill." }], "sentient": false }, "epic": { "id": "9", "themes": ["wizard"], "rarity": "epic", "isNegative": false, "name": "The Halberd of the Peacock", "pronouns": "object", "description": "Its head is covered in squiggly grooves, lined with tin, and the shaft has a peacock feather pinned to it.", "damage": { "as": "polearm", "const": 2 }, "toHit": 2, "active": { "maxCharges": 11, "rechargeMethod": "all charges when its wielder views the night sky", "powers": [{ "desc": "Instant Door", "cost": 5, "additionalNotes": ["Trace the outline of the doorway on a surface using the weapon. A moment later, it's magically created.", "The door can punch through a thin sheet of metal (except lead), or 10-ft of any other material."] }, { "desc": "Ward Other", "cost": 1, "additionalNotes": ["You wave the weapon at another character, as it summons sigils of arcane warding around them.", "For the rest of the scene, spells targeted at them have a 1-in-4 chance to deflect back at the caster."] }] }, "passivePowers": [{ "desc": "The wielder can summon the weapon into their hand at will, so long as it's on the same plane." }, { "desc": "Wisps.", "additionalNotes": ["Each hit you land with the weapon generates a wisp, which dissipate when combat ends.", "On your turn, you can launch any number of wisps (instantly / as no action).", "They deal d4 damage, range as bow."] }], "sentient": false }, "legendary": { "id": "9", "themes": ["steampunk", "wizard"], "rarity": "legendary", "isNegative": false, "name": "Bavin, the Ultraviolet Bardiche", "pronouns": "masc", "description": "His head has a glass bulb running down the middle which blasts ultraviolet light in all directions, and four white eyes mounted in two sets, indented slightly into the surface. His shaft is engraved with luminous depictions of the constellations.", "damage": { "as": "polearm", "const": 4 }, "toHit": 4, "active": { "maxCharges": 12, "rechargeMethod": "one charge when his wielder finishes reading a new book", "powers": [{ "desc": "Creation", "cost": "a charge per month that an expert would need to produce a regular version of the object", "additionalNotes": ["Magically summon a facsimile of an object of your choice.", "It's made of partially opaque magical force. Initially intangible, it finishes solidifying at the start of your next turn.", "Only replicates the form of the object, not any special functions. Its magical nature is obvious at a glance."] }, { "desc": "Ultraviolet Blast", "cost": 2, "additionalNotes": ["You strike at the air, launching a wave of ultraviolet energy.", "It deals 2d6 + 8 damage, range as sling."] }, { "desc": "Switch Trick", "cost": 3, "additionalNotes": ["You point the weapon at up to 4 characters of your choice. They switch places in a flash of smoke."] }, { "desc": "Magic Shield", "cost": 2, "additionalNotes": ["In response to being attacked, the weapon projects a magical force-field.", "The attacker suffers -5 to hit."] }, { "desc": "Spectral Strike", "cost": "at will", "additionalNotes": ["You empower an attack to bypass defenses. During the attack the weapon can phase through terrain, and ignores the effects of armor."] }] }, "passivePowers": [{ "desc": "Deals 3d8 additional damage vs dragons." }, { "desc": "Weapon is an expert astrologer." }, { "desc": "Whenever the wielder defeats a foe, the weapon gains 2d12 damage until the end of their turn (stacks)." }], "sentient": { "personality": ["Skeptic.", "Impatient."], "languages": ["Common.", "A long-lost language.", "The Machine Language used to instruct Clockwork Constructs."], "chanceOfMakingDemands": 6 } } }, "n": 0.09010026997864096 },
        },
        {
            id: '6', version: 0,
            expected: { "weapons": { "common": { "id": "6", "themes": ["sweet"], "rarity": "common", "isNegative": false, "name": "Liquorice Morning-Star", "pronouns": "object", "description": "Its head is made of gingerbread, and the grip is made of liquorice root.", "damage": { "as": "mace", "const": 0 }, "toHit": 0, "active": { "maxCharges": 0, "rechargeMethod": "a charge when used to defeat a foe", "powers": [] }, "passivePowers": [{ "desc": "The wielder magically knows the recipe of any dessert they taste." }], "sentient": false }, "uncommon": { "id": "6", "themes": ["ice"], "rarity": "uncommon", "isNegative": false, "name": "Icy Hammer", "pronouns": "object", "description": "Its shaft has 4 magical gems embedded along it.", "damage": { "as": "mace", "const": 1 }, "toHit": 1, "active": { "maxCharges": 3, "rechargeMethod": "one charge at the end of each scene where its wielder made an ice pun", "powers": [{ "desc": "Empowered Attack", "cost": 2, "additionalNotes": ["You empower an attack to deal an additional 1d8 damage, as the weapon's head momentarily drops to absolute zero."] }] }, "passivePowers": [{ "desc": "Streak.", "additionalNotes": ["Upon a hit, the weapon gains +1 to hit.", "It can store up to +4, and its gems light up to indicate the current streak.", "Upon a miss, the weapon's streak is reset to 0."] }], "sentient": false }, "rare": { "id": "6", "themes": ["sour"], "rarity": "rare", "isNegative": false, "name": "The Epee of the Lemon Lord", "pronouns": "object", "description": "Its blade has a number of dark and discolored sections, and the grip is made of lemon tree wood.", "damage": { "as": "sword", "const": 4 }, "toHit": 4, "active": { "maxCharges": 9, "rechargeMethod": "one charge each time its wielder insults someone", "powers": [{ "desc": "Distant Strike", "cost": 1, "additionalNotes": ["For one attack, the weapon projects a larger spectral copy of itself, increasing its range by 10-ft."] }] }, "passivePowers": [{ "desc": "Wielder is immune to the harmful effects of corrosive chemicals." }], "sentient": false }, "epic": { "id": "6", "themes": ["ice"], "rarity": "epic", "isNegative": false, "name": "The Meteor Hammer of the narwhal", "pronouns": "object", "description": "Its grip is made of narwhal horn.", "damage": { "as": "mace", "const": 4 }, "toHit": 4, "active": { "maxCharges": 11, "rechargeMethod": "one charge whenever its wielder builds a snowman", "powers": [{ "desc": "Ice Maker", "cost": "a charge per month that an expert would need to produce a regular version of the object", "additionalNotes": ["Call forth a tempest of frigid air, which freezes into a facsimile of an object of your choice.", "It's made of solid ice. Initially intangible, it finishes solidifying at the start of your next turn.", "Only replicates the form of the object, not any special functions. Its magical nature is obvious at a glance."] }] }, "passivePowers": [{ "desc": "While the weapon is drawn the wielder cannot feel fear, and their morale cannot break." }], "sentient": false }, "legendary": { "id": "6", "themes": ["earth", "sour"], "rarity": "legendary", "isNegative": false, "name": "Trilor, the Volcanic Transforming Sniper Scythle", "pronouns": "masc", "description": "His blade is made of telekill alloy, and it is flecked with fiery cracks. His sight has four beady orange eyes mounted in two sets.", "damage": { "as": "greataxe (or musket)", "const": 4 }, "toHit": 4, "active": { "maxCharges": 7, "rechargeMethod": "one charge each time his wielder angers someone by insulting them", "powers": [{ "desc": "Stoneskin", "cost": 2, "additionalNotes": ["In response to being attacked, you briefly turn to stone.", "The attacker suffers -5 to hit."] }, { "desc": "Mailleburn", "cost": 2, "additionalNotes": ["Upon landing a blow, you empower it to melt the target's armor.", "The armor is weaked by one step, or otherwise destroyed. If they are wearing multiple pieces of armor, choose one at random."] }, { "desc": "Cause Nausea", "cost": 1, "additionalNotes": ["You wave the weapon at a character. They must save or waste their turn vomiting."] }, { "desc": "Wall of stone", "cost": 4 }, { "desc": "Spray", "cost": "at will", "additionalNotes": ["The weapon sprays acid in a precise pattern, etching an image of your choice onto a surface."] }] }, "passivePowers": [{ "desc": "Magical effects will not function within 10-ft of the weapon, except those generated by it. The aura is inactive while the weapon is sheathed." }, { "desc": "When the wielder saves against psionic effects, the effects of all relevant skills and bonuses are doubled." }, { "desc": "Shots can richochet off of objects and characters, aiming at something else. Each richochet imposes -10 to hit against the next target." }], "sentient": { "personality": ["Antagonistic.", "Manic."], "languages": ["Common.", "Cyclopean."], "chanceOfMakingDemands": 4 } } }, "n": 0.6911825665743735 },
        },
        {
            id: '7', version: 0,
            expected: { "weapons": { "common": { "id": "7", "themes": ["dark"], "rarity": "common", "isNegative": false, "name": "Obsidian Claymore", "pronouns": "object", "description": "Its blade is made of obsidian.", "damage": { "as": "greatsword", "const": 0 }, "toHit": 0, "active": { "maxCharges": 0, "rechargeMethod": "one charge upon absorbing a human soul", "powers": [] }, "passivePowers": [{ "desc": "+5 to hit and damage vs foes more powerful than the wielder." }], "sentient": false }, "uncommon": { "id": "7", "themes": ["cloud"], "rarity": "uncommon", "isNegative": false, "name": "Silver Lucerne", "pronouns": "object", "description": "Its head has 2 magical gems embedded along it, and the grip is made of silver.", "damage": { "as": "greatclub", "const": 2 }, "toHit": 2, "active": { "maxCharges": 3, "rechargeMethod": "all charges when its wielder survives a significant fall", "powers": [{ "desc": "Wind Blast", "cost": 2, "additionalNotes": ["Characters in melee range must save, or take 1d4 damage, be thrown back out of melee range, and knocked down."] }] }, "passivePowers": [{ "desc": "Counter.", "additionalNotes": ["Upon a miss, the weapon gains 1 Counter.", "Upon a hit, the wielder may expend all Counter to deal 1d6 additional damage per point expended.", "It can store up to 2 Counter, and its gems light up to indicate the current amount."] }], "sentient": false }, "rare": { "id": "7", "themes": ["fire"], "rarity": "rare", "isNegative": false, "name": "Fiery Khopesh", "pronouns": "object", "description": "Its blade is made of copper.", "damage": { "as": "sword", "const": 3 }, "toHit": 3, "active": { "maxCharges": 9, "rechargeMethod": "all charges at noon on the summer solstice", "powers": [{ "desc": "Arc Cutter", "cost": 5, "additionalNotes": ["A thin blade of fire surges from the weapon's tip, lasting for 1 minute.", "It can cut through up to a foot of metal (or similar material)."] }] }, "passivePowers": [{ "desc": "Whenever the wielder defeats a foe, they may immediately make another attack." }], "sentient": false }, "epic": { "id": "7", "themes": ["light"], "rarity": "epic", "isNegative": false, "name": "Penus, the Stiletto  of Selene", "pronouns": "masc", "description": "His blade is made of silver-plated steel, and his grip is made of birch wood. His crossguard has a single beady white eye.", "damage": { "as": "dagger", "const": 4 }, "toHit": 4, "active": { "maxCharges": 11, "rechargeMethod": "all charges at noon on the summer solstice", "powers": [{ "desc": "You Are Being Watched", "cost": 3, "additionalNotes": ["Upon landing a blow (on a person), you empower it to draw divine attention to them.", "You magically know the target's location. The effect lasts for a week, or until the target dies."] }, { "desc": "Distant Strike", "cost": 1, "additionalNotes": ["For one attack, the weapon projects a larger spectral copy of itself, increasing its range by 20-ft."] }] }, "passivePowers": [{ "desc": "The wielder can make one more attack than they would normally be able to each turn." }], "sentient": { "personality": ["Honest.", "Zealous."], "languages": ["Common.", "Metal-Draconic."], "chanceOfMakingDemands": 6 } }, "legendary": { "id": "7", "themes": ["light"], "rarity": "legendary", "isNegative": false, "name": "Trimerion, the Emerald Tanto", "pronouns": "masc", "description": "His blade has channels of brilliant green light spreading out from its base and across its surface in an organic fractal, and his crossguard has a single beady yellow eye.", "damage": { "as": "dagger", "const": 5 }, "toHit": 5, "active": { "maxCharges": 5, "rechargeMethod": "all charges after an hour in a sacred space", "powers": [{ "desc": "Distant Strike", "cost": 1, "additionalNotes": ["For one attack, the weapon projects a larger spectral copy of itself, increasing its range by 20-ft."] }, { "desc": "Return", "cost": 3, "additionalNotes": ["The weapon is bound to a particular location, you can slice the air to open a portal to it. It stays open for 1 minute before collapsing.", "The location is fixed and decided by the referee. Typical locations include the place the weapon was forged, or the fortress of a previous wielder."] }, { "desc": "Kinesis", "cost": 1, "additionalNotes": ["The weapon emits a tether of green energy. It can lift and throw an object within 60-ft, weighing up to 500 lbs."] }, { "desc": "Focus Strike", "cost": 1, "additionalNotes": ["You mentally sync with the weapon, granting +1d12 to hit this attack."] }, { "desc": "Fantasy Form", "cost": "at will", "additionalNotes": ["Light emanates from the weapon, forming a facsimile of an object of your choice.", "It's made of hard-light. Initially intangible, it finishes solidifying at the start of your next turn.", "Only replicates the form of the object, not any special functions. Its magical nature is obvious at a glance."] }] }, "passivePowers": [{ "desc": "The wielder can make one more attack than they would normally be able to each turn." }, { "desc": "Characters touching the weapon cannot lie." }, { "desc": "+5 to hit and damage vs foes more powerful than the wielder." }], "sentient": { "personality": ["Honest.", "Zealous."], "languages": ["Common.", "Metal-Draconic.", "Angelic."], "chanceOfMakingDemands": 4 } } }, "n": 0.27925298591418535 },
        },
        {
            id: '10', version: 0,
            expected: { "weapons": { "common": { "id": "10", "themes": ["earth"], "rarity": "common", "isNegative": false, "name": "Marble Battle-Axe", "pronouns": "object", "description": "Its grip is made of marble.", "damage": { "as": "axe", "const": 1 }, "toHit": 1, "active": { "maxCharges": 0, "rechargeMethod": "all charges when its wielder meditates atop a mountain", "powers": [] }, "passivePowers": [{ "desc": "Whenever the wielder defeats a foe, they gain 1d4 temporary hit points." }], "sentient": false }, "uncommon": { "id": "10", "themes": ["dark"], "rarity": "uncommon", "isNegative": false, "name": "Obsidian Naginata", "pronouns": "object", "description": "Its head is made of obsidian.", "damage": { "as": "polearm", "const": 1 }, "toHit": 1, "active": { "maxCharges": 3, "rechargeMethod": "one charge at the end of each scene where its wielder destroyed an object unnecessarily", "powers": [] }, "passivePowers": [{ "desc": "Whenever the wielder defeats a foe, they gain 1d6 temporary hit points." }], "sentient": false }, "rare": { "id": "10", "themes": ["nature"], "rarity": "rare", "isNegative": false, "name": "Emerald Bo-Stick", "pronouns": "object", "description": "Its body is made of birch wood, and it has luminous vines emerging from a crack in its centre, spreading outwards to wrap around it.", "damage": { "as": "staff", "const": 2 }, "toHit": 2, "active": { "maxCharges": 3, "rechargeMethod": "all charges at noon on the summer solstice", "powers": [{ "desc": "Energy Ball", "cost": 3, "additionalNotes": ["An orb of green energy forms at the weapon's tip, hovering around eye level. At the start of each of your turns, it moves 10-ft closer to the nearest foe.", "If touched, it explodes with a 30-ft radius. Targets save, taking 10d10 damage on a fail and half as much on a success."] }] }, "passivePowers": [{ "desc": "Cute animals follow the wielder's polite requests i.e. cats and forest birds." }], "sentient": false }, "epic": { "id": "10", "themes": ["nature"], "rarity": "epic", "isNegative": false, "name": "Disor, the Dagger  of the Beetle", "pronouns": "masc", "description": "His blade is made of copper, and his grip is made of beetle shell. His crossguard has three brown eyes shaped like a cuttlefish's mounted in a triangle.", "damage": { "as": "dagger", "const": 4 }, "toHit": 4, "active": { "maxCharges": 5, "rechargeMethod": "a charge when used to defeat a foe", "powers": [{ "desc": "Toxicity", "cost": 3, "additionalNotes": ["Infuse a strike with lingering poison, dealing d6 damage to the target at the start of each of their turns.", "Each time it deals damage, the effect has a 1-in-10 chance of wearing off."] }] }, "passivePowers": [{ "desc": "Whenever the wielder defeats a foe, they turn invisible until the start of their next turn." }], "sentient": { "personality": ["Superstitious.", "Honest."], "languages": ["Common.", "The language of wolves"], "chanceOfMakingDemands": 10 } }, "legendary": { "id": "10", "themes": ["ice", "sour"], "rarity": "legendary", "isNegative": false, "name": "Kashin, the Frostbound Hammer", "pronouns": "masc", "description": "His head is made of citrine, it has a number of dark and discolored sections, it has a pair of beady yellow eyes, and a large crystal orb embedded in it, containing a howling blizzard. His grip is made of pine wood.", "damage": { "as": "mace", "const": 4 }, "toHit": 4, "active": { "maxCharges": 5, "rechargeMethod": "one charge at the end of each scene where his wielder made an ice pun", "powers": [{ "desc": "Ice Blast", "cost": 2, "additionalNotes": ["You strike at the air, launching a snowflake shuriken.", "It deals 2d6 + 8 damage, range as sling."] }, { "desc": "Parry", "cost": 2, "additionalNotes": ["In response to being attacked, the weapon magically guides your hand to parry the blow.", "The attacker suffers -5 to hit."] }, { "desc": "Disarm", "cost": "at will", "additionalNotes": ["The weapon magically guides your hand to disarm an opponent.", "They are forced to drop an object they're holding, no save."] }] }, "passivePowers": [{ "desc": "Whenever the wielder defeats a foe, they may immediately make another attack." }, { "desc": "Wielder is immune to the harmful effects of corrosive chemicals." }, { "desc": "Magical effects will not function within 10-ft of the weapon, except those generated by it. The aura is inactive while the weapon is sheathed." }], "sentient": { "personality": ["Vengeful.", "Jealous."], "languages": ["Common.", "Frost Giant.", "White-Draconic."], "chanceOfMakingDemands": 8 } } }, "n": 0.9071376291287513 },
        },
        {
            id: '11', version: 0,
            expected: { "n": 0.2694488477791326, "weapons": { "common": { "active": { "maxCharges": 0, "powers": [], "rechargeMethod": "a charge when used to defeat a foe" }, "damage": { "as": "greatsword", "const": 0, "d6": 1 }, "description": "Its blade is made of obsidian, and it leaves a wake of pure darkness behind it.", "id": "11", "isNegative": false, "name": "Obsidian Greatsword", "passivePowers": [], "pronouns": "object", "rarity": "common", "sentient": false, "themes": ["dark"], "toHit": 0 }, "epic": { "active": { "maxCharges": 11, "powers": [{ "additionalNotes": ["Dissipates after 1 hour."], "cost": 6, "desc": "Summon Fire Elemental" }], "rechargeMethod": "a charge when used to defeat a foe" }, "damage": { "as": "staff", "const": 4 }, "description": "Its body is made of gold, and it has patterns on its surface depicting purple flames radiating outwards from the base.", "id": "11", "isNegative": false, "name": "The Bo-Stick of the Bonfire Keeper", "passivePowers": [{ "desc": "Can transform into a 10-ft pole, or shrink to the size of a toothpick." }, { "desc": "The wielder gains a +5 bonus to feats of strength or agility that involve the weapon." }], "pronouns": "object", "rarity": "epic", "sentient": false, "themes": ["fire"], "toHit": 4 }, "legendary": { "active": { "maxCharges": 11, "powers": [{ "additionalNotes": ["Lock a mechanism in place with magical ice as strong as steel.", "It stays frozen for 2d6 × 10 minutes."], "cost": 1, "desc": "Icebound" }, { "additionalNotes": ["A sphere of ice forms at the weapon's tip, hovering around eye level. At the start of each of your turns, it moves 10-ft closer to the nearest foe.", "If touched, it explodes with a 30-ft radius. Targets save, taking 10d12 damage on a fail and half as much on a success."], "cost": 3, "desc": "Slow Bomb" }, { "additionalNotes": ["A wave of frost emanates from the weapon. Surfaces and bodies of liquid within a 120-ft radius freeze into a sheet of ice. The wielder decides how thick the ice is (max 1-ft)."], "cost": 2, "desc": "Ice Sheet" }, { "additionalNotes": ["You level the weapon at another character, and the atmosphere freezes around them as armor.", "It has stats as plate (+2). At the end of the scene, it shatters and falls off."], "cost": 1, "desc": "Frigid Plate" }, { "additionalNotes": ["The weapon magically guides your hand to disarm an opponent.", "They are forced to drop an object they're holding, no save."], "cost": "at will", "desc": "Disarm" }], "rechargeMethod": "one charge at the end of each scene where his wielder made an ice pun" }, "damage": { "as": "sword (or bow)", "const": 4 }, "description": "His blades each have a large crystal orb embedded in them, containing a welter of winter weather, and his quiver has a pair of blue eyes indented slightly into the surface.", "id": "11", "isNegative": false, "name": "Bavin, the Icebound Bladed Bow", "passivePowers": [{ "desc": "Can transform into a set of ice picks." }, { "desc": "When the weapon's blade is coated in the blood of a character with an elemental weakness, it glows the color of the element they're weak to, as bright as a torch." }, { "desc": "Anything killed by the weapon explodes in a blast of icy wind. The blast deals 2d6 damage, with a range of 10-ft. It does not harm the wielder." }], "pronouns": "masc", "rarity": "legendary", "sentient": { "chanceOfMakingDemands": 6, "languages": ["Common.", "White-Draconic.", "Frost Giant."], "personality": ["Merciless.", "Jealous."] }, "themes": ["ice"], "toHit": 4 }, "rare": { "active": { "maxCharges": 9, "powers": [{ "additionalNotes": ["Molten glass bursts from the weapon, levitating into place to form a facsimile of an object of your choice.", "It's made entirely of glass. Initially intangible, it finishes solidifying at the start of your next turn.", "Only replicates the form of the object, not any special functions. Its magical nature is obvious at a glance."], "cost": "a charge per month that an expert would need to produce a regular version of the object", "desc": "Pile of Glass" }], "rechargeMethod": "all charges at noon on the summer solstice" }, "damage": { "as": "staff", "const": 2 }, "description": "Its body is made of gold-plated steel, and it has patterns on its surface depicting red flames radiating outwards from the base.", "id": "11", "isNegative": false, "name": "Golden Quarterstaff", "passivePowers": [{ "desc": "Can transform into a lighter." }], "pronouns": "object", "rarity": "rare", "sentient": false, "themes": ["fire"], "toHit": 2 }, "uncommon": { "active": { "maxCharges": 4, "powers": [{ "additionalNotes": ["You level the weapon at another character, and they're briefly surrounded by divine light.", "For the rest of the scene, they cannot be cursed."], "cost": 1, "desc": "Protection from Curses" }], "rechargeMethod": "all charges at noon on the summer solstice" }, "damage": { "as": "greatclub", "const": 1 }, "description": "Its head is made of white gold, and the grip is made of crystal.", "id": "11", "isNegative": false, "name": "Golden Greathammer", "passivePowers": [{ "desc": "Whenever the wielder defeats a foe, they gain 1d6 temporary hit points." }], "pronouns": "object", "rarity": "uncommon", "sentient": false, "themes": ["light"], "toHit": 1 } } },
        },
    ] satisfies { id: Parameters<typeof mkWeaponsForAllRarities>[0], version: keyof typeof weaponFeaturesByVersion, expected: ReturnType<typeof mkWeaponsForAllRarities> }[])(
        '10. The weapon that corresponds to a particular set of parameters is fixed and never changes, even when the software is updated.',
        ({ id, version, expected }) => {
            expect(mkWeaponsForAllRarities(id, weaponFeaturesByVersion[version], undefined, undefined, true)).toEqual(expected);
        }
    );
})